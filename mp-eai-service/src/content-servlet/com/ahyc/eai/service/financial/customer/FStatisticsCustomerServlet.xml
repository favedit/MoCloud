<?xml version="1.0" encoding="UTF-8" ?>

<Config>

<Resource name='sql.dynamic.sum'>
SELECT
   SUM(INVESTMENT) INVESTMENT_COUNT,
   MAX(INVESTMENT_TOTAL) INVESTMENT_TOTAL,
   SUM(CUSTOMER_COUNT) CUSTOMER_COUNT,
   MAX(CUSTOMER_TOTAL) CUSTOMER_TOTAL
FROM ST_FIN_PHASE
WHERE RECORD_DAY = STR_TO_DATE({date},'%Y%m%d')
</Resource>

<Resource name='sql.dynamic.rank'>
SELECT * FROM (
   SELECT
      CUSTOMER_ID,
      CUSTOMER_LABEL,
      CUSTOMER_CARD,
      CUSTOMER_PHONE,
      SUM(INVESTMENT) INVESTMENT_TOTAL
   FROM ST_FIN_CUSTOMER_PHASE
   WHERE RECORD_DAY = STR_TO_DATE({date},'%Y%m%d')
   GROUP BY CUSTOMER_ID
) t
ORDER BY INVESTMENT_TOTAL DESC
LIMIT 3
</Resource>

<Resource name='sql.customer.province'>
SELECT
   LEFT(CARD, 2) PROVINCE_CODE,
   COUNT(*) CUSTOMER_COUNT,
   SUM(INVESTMENT_TOTAL) INVESTMENT_TOTAL,
   SUM(INVESTMENT_TOTAL)/COUNT(*) INVESTMENT_AVG
FROM ST_FIN_CUSTOMER
GROUP BY LEFT(CARD, 2)
ORDER BY CARD
</Resource>

<Resource name='sql.customer.age'>
SELECT
   {year} - LEFT(CUSTOMER_BIRTH, 4) CUSTOMER_AGE,
   LEFT(CUSTOMER_BIRTH, 4) CUSTOMER_YEAR,
   COUNT(*) CUSTOMER_COUNT,
   SUM(IF(CUSTOMER_GENDER=1, 1, 0)) MALE_COUNT,
   SUM(IF(CUSTOMER_GENDER=2, 1, 0)) FEMALE_COUNT,
   SUM(INVESTMENT_TOTAL) INVESTMENT_TOTAL,
   SUM(INVESTMENT_TOTAL) / COUNT(*) INVESTMENT_AVG
FROM ST_FIN_CUSTOMER_AMOUNT
   GROUP BY LEFT(CUSTOMER_BIRTH, 4)
ORDER BY CUSTOMER_BIRTH DESC
</Resource>

</Config>
